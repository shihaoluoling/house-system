<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.admin.center.manual.dao.ProductMapper">
    <resultMap id="BaseResultMap" type="com.example.admin.center.manual.model.CartProduct">
        <result column="cart_code" jdbcType="VARCHAR" property="cartCode"/>
        <result column="product_id" jdbcType="INTEGER" property="productId"/>
        <result column="quantity" jdbcType="INTEGER" property="quantity"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="modify_date" jdbcType="TIMESTAMP" property="modifyDate"/>
        <result column="id" jdbcType="INTEGER" property="id"/>
        <result column="product_name" jdbcType="VARCHAR" property="productName"/>
        <result column="subscribe_quantity" jdbcType="INTEGER" property="subscribeQuantity"/>
        <result column="product_quantity" jdbcType="INTEGER" property="productQuantity"/>
        <result column="price" jdbcType="DECIMAL" property="price"/>
        <result column="product_desc" jdbcType="VARCHAR" property="productDesc"/>
    </resultMap>

	<resultMap id="BaseResultMap1" type="com.example.admin.center.model.HotelProduct">
		<!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jan 11 15:33:11 CST 2021.
        -->
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="product_name" jdbcType="VARCHAR" property="productName" />
		<result column="product_desc" jdbcType="VARCHAR" property="productDesc" />
		<result column="subscribe_quantity" jdbcType="INTEGER" property="subscribeQuantity" />
		<result column="quantity" jdbcType="INTEGER" property="quantity" />
		<result column="price" jdbcType="DECIMAL" property="price" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="last_modifier" jdbcType="VARCHAR" property="lastModifier" />
		<result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
		<result column="is_deleted" jdbcType="SMALLINT" property="isDeleted" />
	</resultMap>
    <select id="selectCart" resultMap="BaseResultMap">
SELECT
	h1.cart_code,
	h1.product_id,
	h1.quantity,
	h1.user_id,
	h1.modify_date,
	h1.id,
	h2.product_name,
	h2.subscribe_quantity,
	h2.quantity product_quantity,
	h2.price,
	h2.product_desc
FROM
	`hotel_cart` h1
	LEFT JOIN hotel_product h2 ON h1.product_id = h2.id
WHERE
	h1.cart_code = #{cartCode}
	and h1.is_deleted = 0
    </select>

	<select id="selectProduct" resultMap="BaseResultMap1">
SELECT
	*
FROM
	hotel_product
WHERE
	hotel_product.id NOT IN
	 ( SELECT product_id FROM hotel_cart WHERE hotel_cart.cart_code = #{cartCode} and is_deleted = 0)
	 and is_deleted = 0
	 and quantity > 0
	 ORDER BY
	 hotel_product.modify_time desc
    </select>

	<update id="quantity">
		UPDATE hotel_product
SET quantity = quantity - 1
WHERE
	id = 1
	AND quantity - 1 >= 0
	</update>
</mapper>
